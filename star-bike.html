<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>BullWatt Activity</title>  

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">


    <style>
        td { 
          font-size: 30px; 
          /*border: 1px dotted white;   
          border-collapse: collapse;*/
          padding-left: 15px;
          padding-right: 15px;
        }
        
        #containerData {
          position: absolute;
          bottom: 0;
          width: 100%;
          color : white;
          font-family: system-ui;
          text-align: center;
        }

        .indicators 
        {
          font-size: 50%;
        }

        table
        { 
            margin-left: auto;
            margin-right: auto;
        }

        #containerTimer
        {
          position: absolute;
          top: 0;
          width: 100%;
          color : white;
          font-family: system-ui;
          /*padding: 15px;*/
          font-size: 60px; 
          text-align: center;
        }
      </style>
    
  </head>

  <body  style="margin:0px;">
    
    
<div id="containerTimer">
  <table style="width:100%">
    <tr>
      <td>TIME</td>
      <td>
        CONTROL
        <br />
        <button id="readFTMSMeasure">Connect BLE</button>
        <button id="stopButton" disabled>Stop</button>
      </td>
      <td>DISTANCE</td>
    </tr>
    <tr>
      <td width="33%">
        <div id="elapsedTimer">00:00</div>
      </td>
      <td width="33%">
        <table>
          <tr>
            <td>
              <button type="button" id="buttonDecreaseWatt">-10</button>

           </td>
            <td  id="valueTabControlWatt" style="font-size: 200%;">
              50 W
            </td>
            <td>
              <button type="button" id="buttonIncreaseWatt">+10</button>
            </td>
          </tr>
        </table>
      
      </td>


      <td width="33%" >
        <span  id="valueDistance" >0</span> KM
      </td>
    </tr>
  </table>
  

</div>






<div id="containerData">
    <table style="width:100%">
      <tr>
        <td>CADENCE</td>
        <td>SPEED</td>
        <td>POWER</td>
      </tr>
      <tr>
        <td width="33%">
          <table>
            <tr>
              <td>
                <span  class="indicators" >AVG</span>
                <br/>
                <span  id="valueTabCadenceAVG" >0</span>
             </td>
              <td  id="valueTabCadence" style="font-size: 300%;">
                0
              </td>
              <td>
                <span  class="indicators" >BEST</span>
                <br/>
                <span  id="valueTabCadenceBEST" >0</span>
              </td>
            </tr>
          </table>
        </td>


        <td width="33%">
          <table>
            <tr>
              <td>
                <span  class="indicators" >AVG</span>
                <br/>
                <span  id="valueTabPowerAVG" >0</span>
             </td>
              <td  id="valueTabPower" style="font-size: 300%;">
                0
              </td>
              <td>
                <span  class="indicators" >BEST</span>
                <br/>
                <span  id="valueTabPowerBEST" >0</span>
              </td>
            </tr>
          </table>
        </td>

        <td width="33%">
          <table>
            <tr>
              <td>
                <span  class="indicators" >AVG</span>
                <br/>
                <span  id="valueTabSpeedAVG" >0</span>
             </td>
              <td  id="valueTabSpeed" style="font-size: 300%;">
                0
              </td>
              <td>
                <span  class="indicators" >BEST</span>
                <br/>
                <span  id="valueTabSpeedBEST" >0</span>
              </td>
            </tr>
          </table>
        
        </td>

      </tr>
    </table>

    <div id="graphPower" style="width:100%;height: 20vh;"></div>
</div>




  <script>

    var myUUID = null;

    var bluetoothDevice;
    var FTMSService;
    var FTMSMeasureCharacteristic;

    var dataSpeed = [];
    var dataPower = [];
    var dataCadence = [];
    var dataPowerDisplay = [];
    var speed = 0;
    var power = 0;
    var cadence = 0;
    var currentPower = 50;
    
    
    const serviceFTMS = 0x1826;
    const indoorBikeData = 0x2AD2;
    const FTMSControlPoint = 0x2AD9;
    //const CONTROL_POINT_CHARACTERISTIC_UUID = '00002ad9-0000-1000-8000-00805f9b34fb'; // Control Point
    var controlPointCharacteristic = null;

    var intervalTimerId = null;
    var intervalGraphId = null;

    // The wake lock sentinel.
    var wakeLock = null;


    var servicesList = [
    ['FTMS', '00001826-0000-1000-8000-00805f9b34fb'],
    ['Device information', '0000180a-0000-1000-8000-00805f9b34fb'],
    ['Heart Rate', '0x180D']
];


    var activity;
    activity = {
        startTime : 0,
        endTime : 0,
        duration : 0,
        distance : 0,
        timeseries : []
    }; 


    function updateActivity()
    {
        now = new Date();
        if(activity.endTime != 0)
        {
            delta = now.getTime() - activity.endTime.getTime();
            distanceDelta = speed * delta / 3600000;
            activity.distance = activity.distance + distanceDelta;
            dist = parseFloat(activity.distance).toFixed(2);
            document.getElementById("valueDistance").textContent = dist;
        }

        var point;
        point = 
        {
            time : now,
            power : power,
            speed : speed,
            cadence : cadence,
            distance : (activity.distance*1000)
        };

        activity.timeseries.push(point);
        
        activity.endTime = now;
        activity.duration = (activity.endTime.getTime() - activity.startTime.getTime())/1000;
    }

    async function connectBLE() {
      try {
        if (!bluetoothDevice) {
          await requestDevice();
        }
        await connectDeviceAndCacheCharacteristics();

        console.log('> Notifications starting');
        await FTMSMeasureCharacteristic.startNotifications();
        console.log('> Notifications started');
          
          //Start Chrono
          startTime = new Date();
          activity.startTime = startTime; 
          intervalTimerId = setInterval(handler, 1000);
          handler();


          //start timer Watt Graph
          intervalGraphId = setInterval(handlerGraph, 5000);
          handlerGraph();
          

          //Start Notif
          //indoorBikeDataCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);

          document.getElementById("readFTMSMeasure").textContent = "CONNECTED";
          document.querySelector('#stopButton').disabled = false;

        

      } catch(error) {
        console.log('Argh! ' + error);
      }
    }


    async function requestDevice() {
      
      optServicesList = '';
      servicesList.forEach(srv => {
        optServicesList +=  srv[1] + ',';
      });

      console.log(optServicesList);

      let optionalServices = optServicesList
      .split(/, ?/).map(s => s.startsWith('0x') ? parseInt(s) : s)
      .filter(s => s && BluetoothUUID.getService);


      console.log('Requesting any Bluetooth Device...');
      bluetoothDevice = await navigator.bluetooth.requestDevice({
        filters:[{
            services: [parseInt('0x180A')],
        }],
          //acceptAllDevices: true,
          optionalServices: optionalServices
        });



        
    }

    async function connectDeviceAndCacheCharacteristics() {
      if (bluetoothDevice.gatt.connected && FTMSMeasureCharacteristic) {
        return;
      }
    
      console.log('Connecting to GATT Server...');
      const server = await bluetoothDevice.gatt.connect();
      

      console.log('Getting Device Information Service...');
      const service = await server.getPrimaryService(parseInt('0x180A'));
    
      var enc = new TextDecoder("utf-8");

      var testExistingSoftwareRevision = false;
      ListCharacteristic =  await service.getCharacteristics();
      ListCharacteristic.forEach(element => {
        console.log("charac existing : " + element.uuid);
        if(element.uuid.includes("2a28")) testExistingSoftwareRevision = true;
      });

      ManufacturerCharacteristic = await service.getCharacteristic(parseInt('0x2A29'));
      const value = await ManufacturerCharacteristic.readValue();
      console.log("Manufacturer Name" + enc.decode(value));
      //addRow("dataTable", "Manufacturer Name", enc.decode(value));
      

      ModelCharacteristic = await service.getCharacteristic(parseInt('0x2A24'));
      const valueModel = await ModelCharacteristic.readValue();
      console.log("Model Number" + enc.decode(valueModel));
      //addRow("dataTable", "Model Number", enc.decode(valueModel));
      

      

      //Test services
       service2 = await server.getPrimaryService(parseInt('0x00001826-0000-1000-8000-00805f9b34fb'));
       console.log('> Service direct FTMS: ' + service2.uuid);


       console.log('Getting Services...');
      const services = await server.getPrimaryServices();

      
      for (const service3 of services) {
        console.log('> Service: ' + service3.uuid)
        
        servicesList.forEach(srv => {
            if(srv[1] == service3.uuid)  console.log(srv[0]);
            else if(srv[1].startsWith('0x'))
            {
              if(srv[1].substring(2, 5) == service3.uuid.substring(4,7)) console.log(srv[0]);
            }
          });
        ;
    }
    

/*
      await FTMSCharacteristic.startNotifications();

        log('> Notifications started');
        FTMSCharacteristic.addEventListener('characteristicvaluechanged',
            handleNotifications);
      */

    // FTMS Streaming Indoor Bike Data
      console.log('Getting FTMS Service...');
      //const 
      service4 = await server.getPrimaryService(serviceFTMS); 
      console.log('Getting FTMS Characteristic...');
      FTMSMeasureCharacteristic = await service4.getCharacteristic(indoorBikeData);
      FTMSMeasureCharacteristic.addEventListener('characteristicvaluechanged',
          handleFTMSMeasureChanged);
      console.log('Done FTMS Characteristic...');

    // Init Control
    console.log('Getting Control point Characteristic...');
    controlPointCharacteristic = await service4.getCharacteristic(FTMSControlPoint);

    // Request control of the fitness machine
    await requestControl(controlPointCharacteristic);

    // Write to the control point to set the resistance to currentPower W
    await setResistance(controlPointCharacteristic, currentPower);

    console.log('Resistance set to currentPower W');
    }


    // Function to request control of the fitness machine
    async function requestControl(characteristic) {
      // Command to request control: OpCode = 0x00
      const buffer = new Uint8Array([0x00]);

      // Write the request control command to the characteristic
      await characteristic.writeValue(buffer);
      console.log('Control requested');
    }

    // Function to write to the Control Point characteristic to set resistance
    async function setResistance(characteristic, power) {
      // Convert the power value to a byte array (in watts)
      const buffer = new ArrayBuffer(3);
      const view = new DataView(buffer);

      // Command format for FTMS Control Point: [OpCode, Param1, Param2]
      // OpCode for target power: 0x05
      // Param1: power value in watts (2 bytes)
      view.setUint8(0, 0x05); // OpCode: Set Target Power
      view.setUint16(1, power, true); // currentPower

      // Write the command to the characteristic
      await characteristic.writeValue(buffer);
    }



    function getMax(tab) {
      return Math.round(Math.max(...tab));
    }

    function getAvg(tab) {
      var sum = 0;
      for( var i = 0; i < tab.length; i++ ){
          sum += parseInt( tab[i], 10 ); //don't forget to add the base
      }

      var avg = Math.round(sum/tab.length);
      return avg;
    }



    function getSpeedFromWatt(watt)
    {
      var speed_calculated = 0.7 * Math.sqrt(watt); // m per s
      return speed_calculated * 3.6;
    }


    var handler = function() {
      var mdate = new Date();
      timeElapsed = mdate - startTime;

      let hours = Math.floor((timeElapsed % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      let min = Math.floor((timeElapsed % (1000 * 60 * 60)) / (1000 * 60));
      let sec = Math.floor((timeElapsed % (1000 * 60)) / 1000);

      
      document.getElementById("elapsedTimer").textContent = (min < 10 ? "0" + min : min) + ":" + (sec < 10 ? "0" + sec : sec);
  };


  var handlerGraph = function() {
    dataPowerDisplay.push(currentPower);
    updateCharts();
  };


    
  
    
    /* This function will be called when `readValue` resolves and
     * characteristic value changes since `characteristicvaluechanged` event
     * listener has been added. */
    function handleFTMSMeasureChanged(event) {
      let value = event.target.value;
        let a = [];
        // Convert raw data bytes to hex values just for the sake of showing something.
        // In the "real" world, you'd use data.getUint8, data.getUint16 or even
        // TextDecoder to process raw data bytes.
        for (let i = 0; i < value.byteLength; i++) {
            a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2));
        }
        console.log('> ' + a.join(' '));

        flags = value.getUint16(0, /*littleEndian=*/true);
        nextPosition = 4 // 2octets for flags, 2octets for instant speed

        /*     
        Example here of a flags to indicate which data is present in the data message
        flags 884
        0000 0011 (bit2 : Instantaneous Cadence , bit3 : average cadence)
        0111 0100 (5 resistance Level, 6 Instantaneous Power, 7 Average Power, 9 heart rate)
        */



        if ((flags & (1 << 1)) != 0) {/*log('> Average Speed');*/posAvgSpeed=nextPosition; nextPosition+=2;}
        if ((flags & (1 << 2)) != 0) {/*log('> Instantaneous Cadence');*/posInstCadence=nextPosition; nextPosition+=2;}
        if ((flags & (1 << 3)) != 0) {/*log('> Average Cadence');*/posAvgCadence=nextPosition; nextPosition+=2;}
        if ((flags & (1 << 4)) != 0) {/*log('> Total Distance');*/posTotDistance=nextPosition; nextPosition+=3;}
        if ((flags & (1 << 5)) != 0) {/*log('> Resistance Level');*/posResistance=nextPosition; nextPosition+=2;}
        if ((flags & (1 << 6)) != 0) {/*log('> Instantaneous Power');*/posInstPower=nextPosition; nextPosition+=2;}
        if ((flags & (1 << 7)) != 0) {/*log('> Average Power');*/posAvgPower=nextPosition; nextPosition+=2;} // else +1 ???? because mandatory total expend energy
        if ((flags & (1 << 8)) != 0) {/*log('> Expended Energy');*/posEnergy=nextPosition; nextPosition+=5;}
        if ((flags & (1 << 9)) != 0) {/*log('> Heart Rate');*/posHR=nextPosition; nextPosition+=1;}
        if ((flags & (1 << 10)) != 0) {/*log('> Metabolic Equivalent');*/posMET=nextPosition; nextPosition+=1;}
        if ((flags & (1 << 11)) != 0) {/*log('> Elapsed Time');*/posElapsedTime=nextPosition; nextPosition+=2;}
        if ((flags & (1 << 12)) != 0) {/*log('> Remaining Time ');*/posRemainTime=nextPosition; nextPosition+=2;}

     

        // instantaneous speed
        //speed = value.getUint16(2, /*littleEndian=*/true)/100;
        // we do not use it as it is not always reliable.
   
        

        if (typeof posInstPower != "undefined")
        {
          //console.log('> POWER ' + (value.getInt16(posInstPower, /*littleEndian=*/true)));
          power = value.getInt16(posInstPower, /*littleEndian=*/true);
          document.querySelector('#valueTabPower').textContent = power;
          dataPower.push(power);
          document.querySelector('#valueTabPowerAVG').textContent = getAvg(dataPower);
          document.querySelector('#valueTabPowerBEST').textContent = getMax(dataPower);

          // if we have power we prefer to calculate the speed
          speed = getSpeedFromWatt(power);


        }

        //Speed management
        document.querySelector('#valueTabSpeed').textContent = Math.round(speed);
        dataSpeed.push(speed);
        document.querySelector('#valueTabSpeedAVG').textContent = getAvg(dataSpeed);
        document.querySelector('#valueTabSpeedBEST').textContent = getMax(dataSpeed);



        if (typeof posInstCadence != "undefined")
        {
          //console.log('> Cadence ' + (value.getUint16(posInstCadence, /*littleEndian=*/true)*0.5));
          cadence =  (value.getUint16(posInstCadence, /*littleEndian=*/true)*0.5);
          document.querySelector('#valueTabCadence').textContent = cadence;
          dataCadence.push(cadence);
          document.querySelector('#valueTabCadenceAVG').textContent = getAvg(dataCadence);
          document.querySelector('#valueTabCadenceBEST').textContent = getMax(dataCadence);
        }

        if (typeof posHR != "undefined")
        {
          console.log('> HR ' + (value.getUint8(posHR, /*littleEndian=*/true)));
          hr = value.getUint8(posHR, /*littleEndian=*/true);
          dataHR.push(hr);
        }

        if (typeof posElaspedTime != "undefined")
        {
          console.log('> Elapsed time ' + (value.getUint16(posElaspedTime, /*littleEndian=*/true)));
        }


        updateActivity();
                
      }

      
    

</script>



<script>

    document.querySelector('#readFTMSMeasure').addEventListener('click', function() {
      if (isWebBluetoothEnabled()) {
        connectBLE();
        requestWakeLock();
      }
    }); 

    document.querySelector('#stopButton').addEventListener('click', function() {
      //Close BLE connection
      if (bluetoothDevice) {
        if (bluetoothDevice.gatt.connected && FTMSMeasureCharacteristic) {
          bluetoothDevice.gatt.disconnect();
        }
      }

      // TODO refactor
      power = 0;
      document.querySelector('#valueTabPower').textContent = power;


      if(wakeLock != null)
      {
        wakeLock.release(); //await...
        console.log('Wakelock stopped.');
        wakeLock = null; 
      }

      document.getElementById("readFTMSMeasure").textContent = "Connect";
      //stop timers
      clearInterval(intervalTimerId);
      clearInterval(intervalGraphId);

      // Persist the activity
      // TODO
      const activityJson = JSON.stringify(activity);
      let activities = null;
      let activitiesJson = localStorage.activities;
      if(activitiesJson == null || activitiesJson == "")
      {
        activities = JSON.parse('{"activities": []}');
      }
      else 
      {    
        activities = JSON.parse(activitiesJson);
      }
      activities.activities.push(activity);

      const newActivitiesJson = JSON.stringify(activities);
      localStorage.activities = newActivitiesJson;

      //disable button
      document.querySelector('#stopButton').disabled = true;

    });


    document.querySelector('#buttonIncreaseWatt').addEventListener('click', function() {
        updateWatt(10);
    });

    document.querySelector('#buttonDecreaseWatt').addEventListener('click', function() {
        updateWatt(-10);
    });



    async function updateWatt(val)
    {
      if (controlPointCharacteristic != null) {
        currentPower = currentPower + val;
        if(currentPower<0) currentPower = 0;
        if(currentPower>600) currentPower = 600;

        console.log('Resistance set to currentPower W');

        document.querySelector('#valueTabControlWatt').textContent = currentPower + " W";
        await setResistance(controlPointCharacteristic, currentPower);
        handlerGraph();
      }
      else console.log('Not connected');

    }
  

    // Function that attempts to request a wake lock.
    const requestWakeLock = async () => {
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => {
          console.log('Wake Lock was released');
          wakeLock = null;
        });
        console.log('Wake Lock is active');
      } catch (err) {
        console.error(`${err.name}, ${err.message}`);
      }
    };


   
    function isWebBluetoothEnabled() {
      if (navigator.bluetooth) {
        
        return true;
      } else {
        ChromeSamples.setStatus('Web Bluetooth API is not available.\n' +
            'Please make sure the "Experimental Web Platform features" flag is enabled.');
        return false;
      }
    }
    

  </script>

    <!-- source https://gist.github.com/GraemeFulton/22fc3fb72a14ce4711c2 -->
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.js"></script>
    <script src="./assets/utils.js"></script>


    <script>

        //Init chart
       
        var domPower = document.getElementById('graphPower');
    
       var chartPower = echarts.init(domPower, null, { renderer: 'canvas', useDirtyRect: false  });

    
        var option;
        option = {
          //title: {
          //    text: 'Power'
          //  },
        backgroundColor: '#000',
        xAxis: {
            type: 'category',
            splitLine:{ show: false },
            axisLine: { show: false },
            axisTick: { show: false },
            axisLabel: { show: false }
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
            data: [],
            type: 'line',
            lineStyle: { // Style de la ligne
              color: 'yellow' // Couleur jaune
            },
            smooth: false
            }
        ]
        };
    

        chartPower.setOption(option);
        window.addEventListener('resize', chartPower.resize);


        function updateCharts()
        {
            
            option.series[0].data = dataPowerDisplay;
            //option.title.text = "Power";
            chartPower.setOption(option);

        }


        window.addEventListener( "keydown",  (event) => {
          if (event.defaultPrevented) {
            return; // Do nothing if the event was already processed
          }

          switch (event.key) {
            case "ArrowDown":
              // Do something for "down arrow" key press.
              updateWatt(-10);
              break;
            case "ArrowUp":
              // Do something for "up arrow" key press.
              updateWatt(10);
              break;
            case "ArrowLeft":
              // Do something for "left arrow" key press.
              updateWatt(-1);
              break;
            case "ArrowRight":
              // Do something for "right arrow" key press.
              updateWatt(1);
              break;
            default:
              return; // Quit when this doesn't handle the key event.
          }

          // Cancel the default action to avoid it being handled twice
          event.preventDefault();
        },
        true,
);


    
</script>    



  <script>
        //Declare three.js variables
	var camera, scene, renderer, stars=[];

    var inverted_power = 300;
	 
     //assign three.js objects to each variable
     function init(){
          
         //camera
         camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
         camera.position.z = 5;	 
 
         //scene
         scene = new THREE.Scene();
          
         //renderer
         renderer = new THREE.WebGLRenderer();
         //set the size of the renderer
         renderer.setSize( window.innerWidth, window.innerHeight );
          
         //add the renderer to the html document body
         document.body.appendChild( renderer.domElement );
     }
 
 
     function addSphere(){
 
                 // The loop will move from z position of -1000 to z position 1000, adding a random particle at each position. 
                 for ( var z= -1000; z < 1000; z+=20 ) {
         
                     // Make a sphere (exactly the same as before). 
                     //var geometry   = new THREE.SphereGeometry(2, 32, 32)
                     var geometry   = new THREE.IcosahedronGeometry(2,0);
                     
                     var material = new THREE.MeshBasicMaterial( {color: 0xffffff} );
                     var sphere = new THREE.Mesh(geometry, material)
         
                     // This time we give the sphere random x and y positions between -500 and 500
                     sphere.position.x = Math.random() * 1000 - 500;
                     sphere.position.y = Math.random() * 1000 - 500;
         
                     // Then set the z position to where it is in the loop (distance of camera)
                     sphere.position.z = z;
         
                     // scale it up a bit
                     sphere.scale.x = sphere.scale.y = 2;
         
                     //add the sphere to the scene
                     scene.add( sphere );
         
                     //finally push it to the stars array 
                     stars.push(sphere); 
                 }
     }
 
     function animateStars() { 
                 
         // loop through each star
         for(var i=0; i<stars.length; i++) {
             
             star = stars[i]; 
                 
             // and move it forward dependent on the mouseY position. 
             star.position.z +=  i * Math.pow((power + 10), 3) / Math.pow(inverted_power, 3);
                 
             // if the particle is too close move it to the back
             if(star.position.z>1000) star.position.z-=2000; 
             
         }
     
     }
 
     function render() {
         //get the frame
         requestAnimationFrame( render );
 
         //render the scene
         renderer.render( scene, camera );
             animateStars();
 
     }
     
     init();
     addSphere();
     render();
  </script>
    

  </body>
</html>
